<!DOCTYPE html>
<html>
<head>  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="stylesheet" type="text/css" href="style.css">    

    <link rel="stylesheet" type="text/css" href="reset.css">

    <link rel="stylesheet" type="text/css" href="font-awesome-4.6.3/css/font-awesome.css">

    <link href='http://fonts.googleapis.com/css?family=Crete+Round' rel='stylesheet' type='text/css'>

    <title>Add Deal</title>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqFzoHdRxRZ3Hrv9jdT_uZbJxayyLUqgw&libraries=places"></script>
    <script type="text/javascript">


        var geocoder;
        var autocomplete;
        var latitudelongitude;
        var binaryPicture;

 // Create a client with the Paho Api. set it to the correct broker ip, port and your "signature"
 var client = new Paho.MQTT.Client("176.10.136.208", 9001, "web" + Math.random());
 
 //Gets  called if the websocket/mqtt connection gets disconnected for any reason
 client.onConnectionLost = function (responseObject) {
     //Messages if the connection is lost
     alert("connection lost: " + responseObject.errorMessage);
 };
 //When a message is recieved from the topic you are subscribed to it gets printed.
 client.onMessageArrived = function (message) {
     //Do something with the push message you received
     $('#messages').append('<span>Topic: ' + message.destinationName + '  | ' + message.payloadString + '</span><br/>');
 };
 //Theese are the options for the connection
 var options = {
     timeout: 3,
     //Messages when the connection is established
     onSuccess: function () {
         client.subscribe('topic', {qos: 2});
     },
     //Messages if the connection was a failure
     onFailure: function (message) {
         alert("Connection failed: " + message.errorMessage);
     }
 };



 function initialize() {

    geocoder = new google.maps.Geocoder();
    autocomplete = new google.maps.places.Autocomplete(
      /** @type {HTMLInputElement} */(document.getElementById('address')),
      { types: ['geocode'],  componentRestrictions: {country: 'swe'} });
    google.maps.event.addListener(autocomplete, 'place_changed', function() {
    });
}

window.onload = function() {

    var fileInput = document.getElementById('fileInput');
    var fileDisplayArea = document.getElementById('fileDisplayArea');


    fileInput.addEventListener('change', function(e) {
        var file = fileInput.files[0];
        var imageType = /image.*/;

        if (file.type.match(imageType)) {
            var reader = new FileReader();

            reader.onload = function(e) {
                fileDisplayArea.innerHTML = "";

                var img = new Image();
                img.src = reader.result;
                binaryPicture = reader.result;

                fileDisplayArea.appendChild(img);
            }

            reader.readAsDataURL(file); 
        } else {
            fileDisplayArea.innerHTML = "File not supported!"
        }
    });
}


var publish = function (payload, topic, qos) {
   var message = new Paho.MQTT.Message(payload);
   message.destinationName = topic;
   message.qos = qos;
   client.send(message);
            //client.disconnect(); 
        };

function publishWithAddress() {
    var check = 0;
    var address = document.getElementById('address');
    var units = document.getElementById('units');
    var price = document.getElementById('price');
    var description = document.getElementById('description');
    var duration = document.getElementById('duration');
    var company = document.getElementById('company');

    geocoder.geocode( { 'address': address.value}, function(results, status) {
      if (status == 'OK') {
        latitudelongitude = results[0].geometry.location;
        check++;
        address.style.border='transparent';

        if (!isNaN(duration.value) && duration.value < 31 && duration.value > 0) {
            check++;
            duration.style.border='transparent';

        } else {
            duration.style.border='solid';
            duration.style.borderColor = "red";
            duration.placeholder = 'Duration must border 1 to 31';
            duration.style.size = '3px';
        }

        if (!isNaN(units.value) && units.value < 100 && units.value > 0) {
            check++;
            units.style.border='transparent';

        } else {
           units.style.border='solid';
           units.style.borderColor = "red";
           units.placeholder = 'Amont of deals must be 1 to 100';
       }

       if (!isNaN(price.value) && price.value > 0) {
        check++;
        price.style.border='transparent';

    } else {
        price.style.border='solid';
        price.style.borderColor = "red";
        price.placeholder = 'Price must be more than 0';
    }

    if (!description.value == "") {
        check++;
        description.style.border='transparent';

    } else {
       description.style.border='solid';
       description.style.borderColor = "red";
       description.placeholder = 'Description cant be empty';
   }

   if (!company.value == "") {
    check++;
    company.style.border='transparent';

} else {
 company.style.border='solid';
 company.style.borderColor = "red";
 company.placeholder = 'Field cant be empty'; 
}

//if (binaryPicture) {
//    check++;
//} else {
//    alert('You need to add a picture');
//}

if (check === 6) {
    alert('Deal added!');
    publish(
        '{target___id: Super special company ID, Data:{ ' +
        'name:' + document.getElementById('company').value + '; ' +
        'picture:' + binaryPicture + '; ' +
        'coordinates:' + latitudelongitude + '; ' +
        'description:' + document.getElementById('description').value + '; ' +
        'price:' + document.getElementById('price').value + '; ' +
        'units:' + document.getElementById('units').value + '; ' +
        'duration:' + document.getElementById('duration').value + ' }; }',
        'topic',2);
    //location.reload();
}

} else {
     document.getElementById('address').style.border='solid';
     document.getElementById('address').style.borderColor = "red";
    document.getElementById('address').placeholder = 'Incorrect adress';  
}

});
}



 // This is the publish method that takes the payload, topic and quality of service.
 // It then creates a paho message with the values given and then sends it.
 

        client.connect(options);
    </script>

</head>

<body onload="initialize()">
    <header>    
        <div class="wrapper">
            <h1>GoGo Deals<span class="color"></span></h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#">Deals</a></li>
                    <li><a href="#">Contact</a></li>
                    
                </ul>
            </nav>
        </div>
    </header>
    <html>


    <div id ="login" > 
        <div class="reg-container">
            <font size="3" color ="white">
                    <br>
                    <input class="form-input" placeholder="Company name" type="text" name="Company" id="company" />
                        <br>
                        <input class="form-input" placeholder="Adress" onFocus="geolocate()" type="text" name="adressbox" id="address" />
                        <br>
                            <input class="form-input" placeholder="Description" type="text"  name="dealdescriptionbox" id="description" />
                            <br>
                                <input class="form-input" placeholder="Price in Kr" type="text" name="originalpricebox" id="price" />
                                <br>
                                    <input class="form-input" placeholder="Duration in days" type="text" name="durationbox" id="duration" />
                                    <br>
                                        <input class="form-input" placeholder="Amount of deals" type="text" name="unitsbox" id="units" />
                                        <br>
                                        <button class="btn-login" onclick="publishWithAddress()">Send</button>
                                        <br>
                                        <b id="pic">Choose picture<b/>
                                            <br>
                                            <br>
                                            <input type="file" id="fileInput">
                                            <br>
                                        </font>

                                        <br>
                                        <div class="img" id="fileDisplayArea"></div>
                                    </div>
                                </div>



                                <footer>
                                    <div class="wrapper">

                                        <div id="footer-info">
                                            <p>Copyright 2016 GoGoDeals. All rights reserved.</p>
                                            <p><a href="#">Terms of Service</a> | <a href="#">Privacy</a></p>
                                        </div>
                                        <div id="footer-links">
                                            <ul>
                                                <li><h5>Company</h5></li>
                                                <li><a href="#">About us</a></li>
                                                <li><a href="#">Meet The Team</a></li>
                                                <li><a href="#">What We Do</a></li>
                                                <li><a href="#">Careers</a></li>
                                            </ul>
                                        </div>
                                        <div class="clear"></div>
                                    </div>
                                </footer>