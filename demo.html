<!DOCTYPE html>
<html>
<head>  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="stylesheet" type="text/css" href="style.css">    

    <link rel="stylesheet" type="text/css" href="reset.css">

    <link rel="stylesheet" type="text/css" href="font-awesome-4.6.3/css/font-awesome.css">

    <link href='http://fonts.googleapis.com/css?family=Crete+Round' rel='stylesheet' type='text/css'>

    <title>Add Deal</title>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script type="text/javascript" src="prototype.js"></script>
    <script type="text/javascript" src="calendarview.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqFzoHdRxRZ3Hrv9jdT_uZbJxayyLUqgw&libraries=places"></script>
    <script type="text/javascript">


        var geocoder;
        var autocomplete;
        var latitude;
        var longitude;
        var binaryPicture;

 // Create a client with the Paho Api. set it to the correct broker ip, port and your "signature"
 var client = new Paho.MQTT.Client("176.10.136.208", 9001, "web" + Math.random());
 
 //Gets  called if the websocket/mqtt connection gets disconnected for any reason
 client.onConnectionLost = function (responseObject) {
     //Messages if the connection is lost
     alert("connection lost: " + responseObject.errorMessage);
 };
 //When a message is recieved from the topic you are subscribed to it gets printed.
 client.onMessageArrived = function (message) {
     //Do something with the push message you received
     $('#messages').append('<span>Topic: ' + message.destinationName + '  | ' + message.payloadString + '</span><br/>');
 };
 //Theese are the options for the connection
 var options = {
   timeout: 3,
     //Messages when the connection is established
     onSuccess: function () {
         //client.subscribe('topic', {qos: 2});
     },
     //Messages if the connection was a failure
     onFailure: function (message) {
       alert("Connection failed: " + message.errorMessage);
   }
};



function initialize() {

    geocoder = new google.maps.Geocoder();
    autocomplete = new google.maps.places.Autocomplete(
      /** @type {HTMLInputElement} */(document.getElementById('address')),
      { types: ['geocode'],  componentRestrictions: {country: 'swe'} });
    google.maps.event.addListener(autocomplete, 'place_changed', function() {
    });
}

function imageHandler(){

    var fileInput = document.getElementById('fileInput');
    var fileDisplayArea = document.getElementById('fileDisplayArea');


    fileInput.addEventListener('change', function(e) {
        var file = fileInput.files[0];
        var imageType = /image.*/;

        if (file.type.match(imageType)) {
            var reader = new FileReader();

            reader.onload = function(e) {
                fileDisplayArea.innerHTML = "";

                var img = new Image();
                img.src = reader.result;
                binaryPicture = reader.result;

                fileDisplayArea.appendChild(img);
            }

            reader.readAsDataURL(file); 
        } else {
            fileDisplayArea.innerHTML = "File not supported!"
        }
    });
}


var publish = function (payload, topic, qos) {
 var message = new Paho.MQTT.Message(payload);
 message.destinationName = topic;
 message.qos = qos;
 client.send(message);
            //client.disconnect(); 
        };

        function publishWithAddress() {
            var check = 0;
            var address = document.getElementById('address');
            var units = document.getElementById('units');
            var price = document.getElementById('price');
            var description = document.getElementById('description');
            var duration = document.getElementById('duration');
            var name = document.getElementById('name');
            var filter = document.getElementById('filter');

            geocoder.geocode( { 'address': address.value}, function(results, status) {
              if (status == 'OK') {
                latitude = results[0].geometry.location.lat();
                longitude = results[0].geometry.location.lng(   );
                check++;
                address.style.border='transparent';

                if (true) {
                    check++;
                    duration.style.border='transparent';

                } else {
                    duration.style.border='solid';
                    duration.style.borderColor = "red";
                    duration.placeholder = 'Duration must border 1 to 31';
                    duration.style.size = '3px';
                }

                if (!filter.value == "") {
                    check++;
                    filter.style.border='transparent';

                } else {
                    filter.style.border='solid';
                    filter.style.borderColor = "red";
                    filter.placeholder = 'Category mus be awsm';
                    filter.style.size = '3px';
                }

                if (!isNaN(units.value) && units.value < 100 && units.value > 0) {
                    check++;
                    units.style.border='transparent';

                } else {
                 units.style.border='solid';
                 units.style.borderColor = "red";
                 units.placeholder = 'Amont of deals must be 1 to 100';
             }

             if (!isNaN(price.value) && price.value > 0) {
                check++;
                price.style.border='transparent';

            } else {
                price.style.border='solid';
                price.style.borderColor = "red";
                price.placeholder = 'Price must be more than 0';
            }

            if (!description.value == "") {
                check++;
                description.style.border='transparent';

            } else {
             description.style.border='solid';
             description.style.borderColor = "red";
             description.placeholder = 'Description cant be empty';
         }

         if (!name.value == "") {
            check++;
            name.style.border='transparent';

        } else {
            name.style.border='solid';
            name.style.borderColor = "red";
            name.placeholder = 'Field cant be empty'; 
        }

//if (binaryPicture) {
//    check++;
//} else {
//    alert('You need to add a picture');
//}

if (check === 7) {
    alert('Deal added!');
    var message = 
    '{"id": "test", "data":{ ' +
    '"client_id": "e0e5e1ab-ad80-11e6-862e-080027e93e17", ' +
    '"name": "' + document.getElementById('name').value + '", ' +
    '"price": ' + document.getElementById('price').value + ', ' +
    '"picture": "' + binaryPicture + '", ' +
    '"description": "' + document.getElementById('description').value + '", ' +
    '"longitude": ' + longitude + ', ' +
    '"latitude": ' + latitude + ', ' +
    '"filters": "' + document.getElementById('filter').value + '", ' +
    '"duration": "' + document.getElementById('duration').value + '", ' +
    '"count": ' + document.getElementById('units').value + ' }, }';
        //var json = JSON.parse(message);
        publish(message,'deal/gogodeals/deal/new',2);
    }


} else {
   document.getElementById('address').style.border='solid';
   document.getElementById('address').style.borderColor = "red";
   document.getElementById('address').placeholder = 'Incorrect adress';  
}

});
        }

        window.onload = function() {
            Calendar.setup({
              dateField     : 'date',
              parentElement : 'calendar'
          })
        }

 // This is the publish method that takes the payload, topic and quality of service.
 // It then creates a paho message with the values given and then sends it.
 

 client.connect(options);
</script>

</head>

<body onload="initialize()">
    <header>    
        <div class="wrapper">
            <h1>GoGo Deals<span class="color"></span></h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <!--<li><a href="#">Deals</a></li>
                    <li><a href="#">Contact</a></li>-->
                    
                </ul>
            </nav>
        </div>
    </header>
    <html>


    <div id ="login" > 
        <div class="reg-container">



            <div id="calendar"></div>
            <div id="date">Select Date</div>

            <img src="images/features-icon-1.png" alt="Smiley face" height="120" width="auto">
            <!--<font size="3" color ="white">-->
            <br>
            <input class="form-input" placeholder="Deal Name" type="text" name="name" id="name" />
            <br>
            <input class="form-input" placeholder="Deal Location" onFocus="geolocate()" type="text" name="adressbox" id="address" />
            <br>
            <input class="form-input" placeholder="Deal Description" type="text"  name="dealdescriptionbox" id="description" />
            <br>
            <input class="form-input" placeholder="Deal Category" type="text"  name="filterbox" id="filter" />
            <br>
            <input class="form-input" placeholder="Price in SEK" type="text" name="originalpricebox" id="price" />
            <br>
            <input class="form-input" placeholder="Deal Duration in Days" type="text" name="durationbox" id="duration" />
            <br>
            <input class="form-input" placeholder="Number of Deals" type="text" name="unitsbox" id="units" />

            <br>
            Select an Image
            <br>

            <input  type="file" onclick="imageHandler()" id="fileInput">
            <br>

            <button class="btn-login" onclick="publishWithAddress()">Send</button>
        </font>

        <br>
        <div class="img" id="fileDisplayArea"></div>
    </div>
</div>



<footer>
    <div class="wrapper">

        <div id="footer-info">
            <p>Copyright 2016 GoGoDeals. All rights reserved.</p>
            <p><a href="#">Terms of Service</a> | <a href="#">Privacy</a></p>
        </div>
        <div id="footer-links">
            <ul>
                <li><h5>name</h5></li>
                <li><a href="#">About us</a></li>
                <li><a href="#">Meet The Team</a></li>
                <li><a href="#">What We Do</a></li>
                <li><a href="#">Careers</a></li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>
</footer>